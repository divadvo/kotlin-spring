<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>
    <!-- Upload Content Fragment -->
    <div th:fragment="content" class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">File Upload & Processing</h3>
        </div>
        <div class="card-body">
            <!-- Error Alert -->
            <div th:if="${error}" class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle"></i>
                <span th:text="${error}"></span>
            </div>

            <!-- Input Mode Selection -->
            <div class="mb-4">
                <label class="form-label">Input Method</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="inputMode" id="fileMode" value="file" 
                           th:checked="${selectedInputMode == null or selectedInputMode == 'file'}">
                    <label class="btn btn-outline-primary" for="fileMode">
                        <i class="bi bi-cloud-upload"></i> File Upload
                    </label>
                    
                    <input type="radio" class="btn-check" name="inputMode" id="textMode" value="text"
                           th:checked="${selectedInputMode == 'text'}">
                    <label class="btn btn-outline-primary" for="textMode">
                        <i class="bi bi-textarea-t"></i> Text Input
                    </label>
                    
                    <input type="radio" class="btn-check" name="inputMode" id="predefinedMode" value="predefined"
                           th:checked="${selectedInputMode == 'predefined'}">
                    <label class="btn btn-outline-primary" for="predefinedMode">
                        <i class="bi bi-file-earmark-text"></i> Sample Data
                    </label>
                </div>
            </div>

            <!-- Data Input Form -->
            <form th:action="@{/my-uploader/upload}" method="post" enctype="multipart/form-data" class="mb-4" id="dataForm">
                <input type="hidden" name="inputMode" id="selectedInputMode" th:value="${selectedInputMode != null ? selectedInputMode : 'file'}">
                
                <!-- Mode 1: File Upload -->
                <div class="mb-3" id="fileUploadSection">
                    <label for="file" class="form-label">Select File for Processing</label>
                    <input type="file" class="form-control" id="file" name="file">
                </div>

                <!-- Mode 2: Text Area -->
                <div class="mb-3" id="textInputSection" style="display: none;">
                    <label for="textContent" class="form-label">XML Content</label>
                    <div id="textContent"></div>
                    <input type="hidden" id="textContentValue" name="textContent" th:value="${preservedTextContent}">
                </div>

                <!-- Mode 3: Predefined Files -->
                <div class="mb-3" id="predefinedFileSection" style="display: none;">
                    <label for="predefinedFile" class="form-label">Select Sample Data</label>
                    <select class="form-select" id="predefinedFile" name="predefinedFile">
                        <option value="">Choose a sample file...</option>
                        <option th:each="file : ${predefinedFiles}" 
                                th:value="${file.relativePath}" 
                                th:selected="${selectedPredefinedFile == file.relativePath}"
                                th:text="${file.displayName}">
                        </option>
                    </select>
                </div>

                <!-- Source Type Selection -->
                <div class="mb-3">
                    <label class="form-label">Source Type</label>
                    <div class="form-check" th:each="sourceType : ${sourceTypes}">
                        <input class="form-check-input" type="radio" 
                               th:name="sourceType" 
                               th:value="${sourceType}" 
                               th:id="${'sourceType' + sourceType}"
                               th:checked="${sourceType == selectedSourceType}"
                               required>
                        <label class="form-check-label" th:for="${'sourceType' + sourceType}" th:text="${sourceType}">
                        </label>
                    </div>
                </div>

                <!-- Processing Mode Selection -->
                <div class="mb-3">
                    <label class="form-label">Processing Mode</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="processingMode" id="processingModeProcess" value="PROCESS" 
                               th:checked="${selectedProcessingMode == null or selectedProcessingMode.toString() == 'PROCESS'}" required>
                        <label class="form-check-label" for="processingModeProcess">
                            <i class="bi bi-gear"></i> Process Data
                            <small class="text-muted d-block">Process input and show booking results</small>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="processingMode" id="processingModeSave" value="SAVE_TO_FOLDER"
                               th:checked="${selectedProcessingMode != null and selectedProcessingMode.toString() == 'SAVE_TO_FOLDER'}" required>
                        <label class="form-check-label" for="processingModeSave">
                            <i class="bi bi-folder"></i> Save to Folder
                            <small class="text-muted d-block">Copy input to designated folder based on source type</small>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="processingMode" id="processingModeMft" value="SIMULATE_MFT"
                               th:checked="${selectedProcessingMode != null and selectedProcessingMode.toString() == 'SIMULATE_MFT'}" required>
                        <label class="form-check-label" for="processingModeMft">
                            <i class="bi bi-cloud-arrow-up"></i> Simulate MFT
                            <small class="text-muted d-block">Placeholder for Event Hub and Blob simulation</small>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="bi bi-play-circle"></i> Process Data
                </button>
            </form>

            <!-- Results Section for Process Data Mode -->
            <div th:if="${bookings}" class="mt-4">
                <div class="alert alert-success" role="alert">
                    <strong>Success!</strong> Processed data from: <span th:text="${sourceDescription}"></span> 
                    with source type: <span th:text="${selectedSourceType}"></span>
                    <br><strong>Total bookings:</strong> <span th:text="${#lists.size(bookings)}"></span>
                </div>
                
                <h4>Booking Results</h4>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setMode('tree')">Tree</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setMode('code')">Code</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setMode('text')">Text</button>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyJson()">
                        Copy JSON
                    </button>
                </div>
                <div id="jsoneditor" style="height: 400px;"></div>
            </div>

            <!-- Results Section for Save to Folder Mode -->
            <div th:if="${savedFilePath}" class="mt-4">
                <div class="alert alert-success" role="alert">
                    <strong>File Saved Successfully!</strong>
                </div>
                
                <h4>File Storage Details</h4>
                <div class="card">
                    <div class="card-body">
                        <p><strong>Source:</strong> <span th:text="${sourceDescription}"></span></p>
                        <p><strong>Source Type:</strong> <span th:text="${selectedSourceType}"></span></p>
                        <p><strong>Saved to:</strong> 
                           <a th:href="@{/my-uploader/view(path=${savedFilePath})}" 
                              class="text-decoration-none">
                              <code th:text="${savedFilePath}"></code>
                           </a>
                        </p>
                        <p><strong>Folder:</strong> 
                           <a th:href="@{/my-uploader/browse(path=${savedFolderPath})}" 
                              class="text-decoration-none">
                              <code th:text="${savedFolderPath}"></code>
                           </a>
                        </p>
                        <p class="text-muted mb-0">
                            <i class="bi bi-info-circle"></i> The file has been copied to the designated folder based on the source type. Click the file path to view content, or the folder path to browse directory.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Results Section for Simulate MFT Mode -->
            <div th:if="${simulateMft}" class="mt-4">
                <div class="alert alert-info" role="alert">
                    <strong>MFT Simulation</strong>
                </div>
                
                <h4>Event Hub and Blob Simulation</h4>
                <div class="card">
                    <div class="card-body">
                        <p><strong>Source:</strong> <span th:text="${sourceDescription}"></span></p>
                        <p><strong>Source Type:</strong> <span th:text="${selectedSourceType}"></span></p>
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-construction"></i> <strong>Not Implemented Yet</strong><br>
                            Event Hub and Blob simulation functionality is not yet implemented.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input Mode Switching Script -->
        <script>
            let codeMirrorEditor = null;
            
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize CodeMirror
                if (window.CodeMirror) {
                    const { EditorView, basicSetup, xml, EditorState } = window.CodeMirror;
                    const initialValue = document.getElementById('textContentValue').value || 
                        `<bookings>
<booking><customerName>John Smith</customerName><amount>250.75</amount></booking>
<booking><customerName>Jane Doe</customerName><amount>189.50</amount></booking>
</bookings>`;
                    
                    codeMirrorEditor = new EditorView({
                        state: EditorState.create({
                            doc: initialValue,
                            extensions: [basicSetup, xml()]
                        }),
                        parent: document.getElementById('textContent')
                    });
                }
                const inputModeRadios = document.querySelectorAll('input[name="inputMode"]');
                const fileUploadSection = document.getElementById('fileUploadSection');
                const textInputSection = document.getElementById('textInputSection');
                const predefinedFileSection = document.getElementById('predefinedFileSection');
                const selectedInputModeField = document.getElementById('selectedInputMode');
                const submitBtn = document.getElementById('submitBtn');
                const dataForm = document.getElementById('dataForm');
                
                // Initialize UI based on server-side selected mode
                initializeMode();
                
                // Handle mode switching
                inputModeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const selectedMode = this.value;
                        selectedInputModeField.value = selectedMode;
                        
                        // Hide all sections first
                        fileUploadSection.style.display = 'none';
                        textInputSection.style.display = 'none';
                        predefinedFileSection.style.display = 'none';
                        
                        // Clear previous validation states
                        clearValidation();
                        
                        // Show selected section and update button text
                        switch(selectedMode) {
                            case 'file':
                                fileUploadSection.style.display = 'block';
                                submitBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Upload & Process';
                                break;
                            case 'text':
                                textInputSection.style.display = 'block';
                                submitBtn.innerHTML = '<i class="bi bi-textarea-t"></i> Process Text';
                                break;
                            case 'predefined':
                                predefinedFileSection.style.display = 'block';
                                submitBtn.innerHTML = '<i class="bi bi-file-earmark-text"></i> Process Sample Data';
                                break;
                        }
                    });
                });
                
                // Form validation before submission
                dataForm.addEventListener('submit', function(e) {
                    const selectedMode = selectedInputModeField.value;
                    let isValid = true;
                    let errorMessage = '';
                    
                    // Sync CodeMirror content to hidden input before validation
                    if (selectedMode === 'text' && codeMirrorEditor) {
                        const content = codeMirrorEditor.state.doc.toString();
                        document.getElementById('textContentValue').value = content;
                    }
                    
                    switch(selectedMode) {
                        case 'file':
                            const fileInput = document.getElementById('file');
                            if (!fileInput.files.length) {
                                isValid = false;
                                errorMessage = 'Please select a file to upload.';
                                showFieldError(fileInput, errorMessage);
                            }
                            break;
                            
                        case 'text':
                            const textContentValue = codeMirrorEditor ? 
                                codeMirrorEditor.state.doc.toString() : 
                                document.getElementById('textContentValue').value;
                            if (!textContentValue.trim()) {
                                isValid = false;
                                errorMessage = 'Please enter XML content.';
                                showFieldError(document.getElementById('textContent'), errorMessage);
                            } else if (!validateXMLFormat(textContentValue)) {
                                isValid = false;
                                errorMessage = 'Please enter valid XML format with bookings structure.';
                                showFieldError(document.getElementById('textContent'), errorMessage);
                            }
                            break;
                            
                        case 'predefined':
                            const predefinedFile = document.getElementById('predefinedFile');
                            if (!predefinedFile.value) {
                                isValid = false;
                                errorMessage = 'Please select a sample data file.';
                                showFieldError(predefinedFile, errorMessage);
                            }
                            break;
                    }
                    
                    if (!isValid) {
                        e.preventDefault();
                        return false;
                    }
                });
                
                // Helper functions
                function clearValidation() {
                    document.querySelectorAll('.is-invalid').forEach(el => {
                        el.classList.remove('is-invalid');
                    });
                    document.querySelectorAll('.invalid-feedback').forEach(el => {
                        el.remove();
                    });
                }
                
                function showFieldError(field, message) {
                    field.classList.add('is-invalid');
                    
                    // Remove existing error message
                    const existingError = field.parentNode.querySelector('.invalid-feedback');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    // Add new error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback';
                    errorDiv.textContent = message;
                    field.parentNode.appendChild(errorDiv);
                }
                
                function validateXMLFormat(text) {
                    try {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(text.trim(), "text/xml");
                        
                        // Check for parsing errors
                        const parserError = xmlDoc.getElementsByTagName("parsererror");
                        return parserError.length === 0;
                    } catch (e) {
                        return false;
                    }
                }
                
                function initializeMode() {
                    const currentMode = selectedInputModeField.value;
                    
                    // Hide all sections first
                    fileUploadSection.style.display = 'none';
                    textInputSection.style.display = 'none';
                    predefinedFileSection.style.display = 'none';
                    
                    // Show the correct section and set button text
                    switch(currentMode) {
                        case 'file':
                            fileUploadSection.style.display = 'block';
                            submitBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Upload & Process';
                            break;
                        case 'text':
                            textInputSection.style.display = 'block';
                            submitBtn.innerHTML = '<i class="bi bi-textarea-t"></i> Process Text';
                            break;
                        case 'predefined':
                            predefinedFileSection.style.display = 'block';
                            submitBtn.innerHTML = '<i class="bi bi-file-earmark-text"></i> Process Sample Data';
                            break;
                    }
                }
            });
        </script>
    </div>
</body>
</html>